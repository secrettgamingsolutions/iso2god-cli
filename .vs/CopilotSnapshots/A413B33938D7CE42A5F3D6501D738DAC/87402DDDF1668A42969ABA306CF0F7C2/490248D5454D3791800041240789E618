namespace Chilano.Iso2God
{
    using System;
    using System.IO;
    using System.Net;
    using System.Text;

    internal class XboxUnityScraper
    {
        private const string API_BASE_URL = "http://xboxunity.net/Resources/Lib/TitleList.php";
        private const int REQUEST_TIMEOUT = 10000; // 10 seconds

        public static string LookupTitleByTitleId(string titleId)
        {
            if (string.IsNullOrEmpty(titleId) || titleId.Length != 8)
            {
                return null;
            }

            try
            {
                // XboxUnity API expects uppercase TitleID
                string url = string.Format("{0}?page=0&count=1&search={1}&sort=0&direction=0&category=0&filter=0",
                    API_BASE_URL, titleId.ToUpper());

                HttpWebRequest request = (HttpWebRequest)WebRequest.Create(url);
                request.Method = "GET";
                request.Timeout = REQUEST_TIMEOUT;
                request.UserAgent = "iso2god-cli/1.0";

                using (HttpWebResponse response = (HttpWebResponse)request.GetResponse())
                {
                    if (response.StatusCode != HttpStatusCode.OK)
                    {
                        return null;
                    }

                    using (StreamReader reader = new StreamReader(response.GetResponseStream(), Encoding.UTF8))
                    {
                        string jsonResponse = reader.ReadToEnd();
                        return ParseTitleNameFromJson(jsonResponse);
                    }
                }
            }
            catch (WebException ex)
            {
                Console.WriteLine("+ XboxUnity API error: " + ex.Message);
                return null;
            }
            catch (Exception ex)
            {
                Console.WriteLine("+ XboxUnity API unexpected error: " + ex.Message);
                return null;
            }
        }

        private static string ParseTitleNameFromJson(string json)
        {
            if (string.IsNullOrEmpty(json))
            {
                return null;
            }

            try
            {
                // Check if we have any items
                int itemsIndex = json.IndexOf("\"Items\"");
                if (itemsIndex == -1)
                {
                    return null;
                }

                // Check if Items array is empty
                int arrayStart = json.IndexOf("[", itemsIndex);
                if (arrayStart == -1)
                {
                    return null;
                }

                int arrayEnd = json.IndexOf("]", arrayStart);
                if (arrayEnd == -1 || arrayEnd - arrayStart <= 1)
                {
                    // Empty array
                    return null;
                }

                // Find the Name field within Items
                int nameIndex = json.IndexOf("\"Name\"", itemsIndex);
                if (nameIndex == -1 || nameIndex > arrayEnd)
                {
                    return null;
                }

                int colonIndex = json.IndexOf(":", nameIndex);
                if (colonIndex == -1)
                {
                    return null;
                }

                int quoteStart = json.IndexOf("\"", colonIndex + 1);
                if (quoteStart == -1)
                {
                    return null;
                }

                int quoteEnd = json.IndexOf("\"", quoteStart + 1);
                if (quoteEnd == -1)
                {
                    return null;
                }

                string titleName = json.Substring(quoteStart + 1, quoteEnd - quoteStart - 1);
                
                // Unescape JSON string
                titleName = titleName.Replace("\\\"", "\"");
                titleName = titleName.Replace("\\\\", "\\");
                titleName = titleName.Replace("\\/", "/");
                
                return string.IsNullOrEmpty(titleName) ? null : titleName;
            }
            catch (Exception ex)
            {
                Console.WriteLine("+ JSON parsing error: " + ex.Message);
                return null;
            }
        }
    }
}
