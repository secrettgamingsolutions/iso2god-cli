namespace Chilano.Xbox360.Xex
{
    using IO;
    using System;
    using System.IO;

    public class XexResourceInfo : XexInfoField
    {
        public static byte[] Signature;
        public uint ResourceDataAddress;
        public uint ResourceDataSize;

        static XexResourceInfo()
        {
            byte[] buffer = new byte[4];
            buffer[2] = 2;
            buffer[3] = 0xff;
            Signature = buffer;
        }

        public XexResourceInfo(uint Address) : base(Address)
        {
        }

        public override void Parse(CBinaryReader br)
        {
            // Address points to a structure in the XEX header
            // Format: Size (4 bytes) + TitleID (8 bytes ASCII) + other metadata
            // The ACTUAL resource data is stored elsewhere in the XEX
            
            br.Seek(Address, SeekOrigin.Begin);
            br.Endian = EndianType.BigEndian;
            
            Console.WriteLine("+ XexResourceInfo.Parse - This structure at 0x" + Address.ToString("X") + " contains metadata, not the actual resource data");
            Console.WriteLine("  The XEX file likely embeds the XDBF data after the code section");
            
            // For now, mark that we don't have direct access to the resource
            ResourceDataSize = 0;
            ResourceDataAddress = 0;
        }

        public byte[] ExtractResource(byte[] xexData)
        {
            // The XDBF data is typically embedded after the executable code
            // Let's search for the XDBF signature in the entire XEX file
            
            Console.WriteLine("+ Searching for XDBF signature in entire XEX file (" + xexData.Length + " bytes)...");
            
            byte[] xdbfSignature = new byte[] { 0x58, 0x44, 0x42, 0x46 }; // "XDBF"
            
            for (int i = 0; i < xexData.Length - 4; i++)
            {
                if (xexData[i] == xdbfSignature[0] &&
                    xexData[i + 1] == xdbfSignature[1] &&
                    xexData[i + 2] == xdbfSignature[2] &&
                    xexData[i + 3] == xdbfSignature[3])
                {
                    Console.WriteLine("+ Found XDBF signature at offset: 0x" + i.ToString("X") + " in XEX file");
                    
                    // Extract from this point to the end of the file
                    int remainingSize = xexData.Length - i;
                    byte[] resourceData = new byte[remainingSize];
                    Array.Copy(xexData, i, resourceData, 0, remainingSize);
                    
                    Console.WriteLine("+ Extracted " + remainingSize + " bytes of XDBF data");
                    return resourceData;
                }
            }
            
            Console.WriteLine("- XDBF signature not found in XEX file");
            return new byte[0];
        }
    }
}

