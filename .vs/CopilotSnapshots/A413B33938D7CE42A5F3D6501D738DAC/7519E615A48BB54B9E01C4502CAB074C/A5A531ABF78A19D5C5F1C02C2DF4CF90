using Chilano.Xbox360.Xdbf;

namespace Chilano.Iso2God
{
    using Xbox360.IO;
    using Xbox360.Iso;
    using Xbox360.Xex;
    using System;
    using System.ComponentModel;
    using System.Diagnostics;
    using System.IO;
    using System.Text;

    internal class IsoDetails
    {
        private IsoDetailsArgs args;
        private FileStream f;
        private GDF iso;

        public IsoDetails(IsoDetailsArgs arguments)
        {
            args = arguments;
        }

        public IsoDetailsResults IsoDetails_DoWork()
        {
            if (openIso())
            {
                if (iso.Exists("default.xex"))
                {
                    return readXex();
                }
                throw new Exception("Could not locate default.xex.");
            }
            throw new Exception("Could not open iso file.");
        }

        private bool openIso()
        {
            try
            {
                f = new FileStream(args.PathISO, FileMode.Open, FileAccess.Read, FileShare.ReadWrite);
                iso = new GDF(f);
            }
            catch (IOException exception)
            {
                Console.WriteLine("- Failed to open ISO image. Reason:\n\n" + exception.Message);
                return false;
            }
            catch (Exception exception2)
            {
                Console.WriteLine("- Unhandled exception occured when opening ISO image. Reason:\n\n" + exception2.Message);
                return false;
            }
            return true;
        }

        private byte[] SearchXdbfInISO()
        {
            Console.WriteLine("+ Searching for XDBF signature in entire ISO...");
            
            try
            {
                // Reopen the file to search from the beginning
                using (FileStream fs = new FileStream(args.PathISO, FileMode.Open, FileAccess.Read, FileShare.ReadWrite))
                {
                    byte[] xdbfSignature = new byte[] { 0x58, 0x44, 0x42, 0x46 }; // "XDBF"
                    byte[] buffer = new byte[4096]; // 4KB buffer
                    int bytesRead;
                    long position = 0;
                    int signatureIndex = 0;
                    long foundPosition = -1;
                    
                    Console.WriteLine("+ ISO size: " + fs.Length + " bytes");
                    long lastReportedMB = 0;
                    
                    while ((bytesRead = fs.Read(buffer, 0, buffer.Length)) > 0)
                    {
                        // Report progress every 100MB
                        long currentMB = position / (1024 * 1024);
                        if (currentMB - lastReportedMB >= 100)
                        {
                            Console.WriteLine("  Scanned: " + currentMB + " MB...");
                            lastReportedMB = currentMB;
                        }
                        
                        for (int i = 0; i < bytesRead; i++)
                        {
                            if (buffer[i] == xdbfSignature[signatureIndex])
                            {
                                signatureIndex++;
                                if (signatureIndex == xdbfSignature.Length)
                                {
                                    foundPosition = position + i - xdbfSignature.Length + 1;
                                    Console.WriteLine("+ Found XDBF signature at offset: 0x" + foundPosition.ToString("X") + " (" + foundPosition + " bytes)");
                                    
                                    // Read the XDBF data from this position
                                    fs.Seek(foundPosition, SeekOrigin.Begin);
                                    
                                    // Read up to 10MB or until end of file
                                    int maxSize = (int)Math.Min(10 * 1024 * 1024, fs.Length - foundPosition);
                                    byte[] xdbfData = new byte[maxSize];
                                    int read = fs.Read(xdbfData, 0, maxSize);
                                    
                                    // Trim to actual size read
                                    if (read < maxSize)
                                    {
                                        byte[] trimmed = new byte[read];
                                        Array.Copy(xdbfData, 0, trimmed, 0, read);
                                        xdbfData = trimmed;
                                    }
                                    
                                    Console.WriteLine("+ Extracted " + xdbfData.Length + " bytes starting from XDBF signature");
                                    return xdbfData;
                                }
                            }
                            else
                            {
                                signatureIndex = 0;
                                // Check if current byte matches first signature byte
                                if (buffer[i] == xdbfSignature[0])
                                {
                                    signatureIndex = 1;
                                }
                            }
                        }
                        
                        position += bytesRead;
                    }
                    
                    Console.WriteLine("- XDBF signature not found in ISO file");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine("- Error searching ISO: " + ex.Message);
            }
            
            return null;
        }

        private string ExtractGameTitleFromXdbf(byte[] xdbfData)
        {
            if (xdbfData == null || xdbfData.Length == 0)
            {
                Console.WriteLine("- XDBF data is empty");
                return null;
            }

            try
            {
                Console.WriteLine("+ Parsing XDBF data (size: " + xdbfData.Length + " bytes)");
                Xdbf xdbf = new Xdbf(xdbfData);

                // Try TitleInfo resource (type 3) - contains the game title
                try
                {
                    byte[] titleResource = xdbf.GetResource(1, 3);
                    if (titleResource != null && titleResource.Length > 0x15)
                    {
                        Console.WriteLine("+ Found TitleInfo resource (size: " + titleResource.Length + " bytes)");
                        
                        MemoryStream stream = new MemoryStream(titleResource);
                        stream.Seek(0x12L, SeekOrigin.Begin);
                        
                        byte[] titleBytes = new byte[Math.Min(256, (int)(stream.Length - 0x12))];
                        int bytesRead = stream.Read(titleBytes, 0, titleBytes.Length);
                        stream.Close();
                        
                        int actualLength = 0;
                        for (int i = 0; i < bytesRead - 1; i += 2)
                        {
                            if (titleBytes[i] == 0 && titleBytes[i + 1] == 0)
                            {
                                actualLength = i;
                                break;
                            }
                        }
                        
                        if (actualLength == 0)
                            actualLength = bytesRead;
                        
                        string name = Encoding.Unicode.GetString(titleBytes, 0, actualLength);
                        
                        if (!string.IsNullOrEmpty(name.Trim()))
                        {
                            Console.WriteLine("+ Extracted title: " + name);
                            return name.Trim();
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine("- Failed to extract from TitleInfo: " + ex.Message);
                }

                // Try Standard resource (type 1)
                try
                {
                    byte[] standardResource = xdbf.GetResource(1, 1);
                    if (standardResource != null && standardResource.Length > 0x15)
                    {
                        Console.WriteLine("+ Found Standard resource (size: " + standardResource.Length + " bytes)");
                        
                        MemoryStream stream2 = new MemoryStream(standardResource);
                        stream2.Seek(0x12L, SeekOrigin.Begin);
                        
                        byte[] titleBytes = new byte[Math.Min(256, (int)(stream2.Length - 0x12))];
                        int bytesRead = stream2.Read(titleBytes, 0, titleBytes.Length);
                        stream2.Close();
                        
                        int actualLength = 0;
                        for (int i = 0; i < bytesRead - 1; i += 2)
                        {
                            if (titleBytes[i] == 0 && titleBytes[i + 1] == 0)
                            {
                                actualLength = i;
                                break;
                            }
                        }
                        
                        if (actualLength == 0)
                            actualLength = bytesRead;
                        
                        string name = Encoding.Unicode.GetString(titleBytes, 0, actualLength);
                        
                        if (!string.IsNullOrEmpty(name.Trim()))
                        {
                            Console.WriteLine("+ Extracted title: " + name);
                            return name.Trim();
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine("- Failed to extract from Standard: " + ex.Message);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine("- Exception parsing XDBF: " + ex.Message);
            }
            
            return null;
        }

        private IsoDetailsResults readXex()
        {
            IsoDetailsResults results = null;
            byte[] bytes = null;

            Console.WriteLine("+ Locating default.xex...");
            try
            {
                bytes = iso.GetFile("default.xex");
                Console.WriteLine("+ Extracting default.xex...");
                if ((bytes == null) || (bytes.Length == 0))
                {
                    throw new Exception("Couldn't locate default.xex. Please check this ISO is valid.");
                }
            }
            catch (Exception exception)
            {
                throw new Exception("A problem occured when reading the contents of the ISO image.\n\nPlease ensure this is a valid Xbox 360 ISO by running it through ABGX360.\n\n" + exception.Message);
            }

            Console.WriteLine("+ Found! Reading default.xex...");
            using (XexInfo info = new XexInfo(bytes))
            {
                if (!info.IsValid)
                {
                    throw new Exception("Default.xex is not valid.");
                }

                if (info.Header.ContainsKey(XexInfoFields.ExecutionInfo))
                {
                    XexExecutionInfo info2 = (XexExecutionInfo)info.Header[XexInfoFields.ExecutionInfo];
                    results = new IsoDetailsResults("", DataConversion.BytesToHexString(info2.TitleID), DataConversion.BytesToHexString(info2.MediaID), info2.Platform.ToString(), info2.ExecutableType.ToString(), info2.DiscNumber.ToString(), info2.DiscCount.ToString());
                }

                // Search for XDBF in the entire ISO file
                Console.WriteLine("+ Extracting game title from ISO...");
                byte[] xdbfData = SearchXdbfInISO();

                string gameName = null;
                if (xdbfData != null && xdbfData.Length > 0)
                {
                    gameName = ExtractGameTitleFromXdbf(xdbfData);
                }

                if (string.IsNullOrEmpty(gameName))
                {
                    Console.WriteLine("- Could not extract game title");
                    Console.WriteLine("+ Using TitleID as game name: " + results.TitleID);
                    results.Name = results.TitleID;
                }
                else
                {
                    results.Name = gameName;
                }

                Console.WriteLine("+ Final game title: " + results.Name);
            }

            return results;
        }
    }
}

