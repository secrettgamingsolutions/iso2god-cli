namespace Chilano.Iso2God
{
    using System;
    using System.IO;
    using System.Net;
    using System.Text;

    internal class XboxUnityScraper
    {
        private const string API_BASE_URL = "http://xboxunity.net/Resources/Lib/TitleList.php";
        private const int REQUEST_TIMEOUT = 15000; // 15 seconds

        public static string LookupTitleByTitleId(string titleId)
        {
            if (string.IsNullOrEmpty(titleId) || titleId.Length != 8)
            {
                return null;
            }

            try
            {
                // Build XboxUnity search API URL with TitleID
                string url = string.Format("{0}?page=0&count=10&search={1}&sort=3&direction=1&category=0&filter=0",
                    API_BASE_URL, titleId.ToUpper());

                Console.WriteLine("+ XboxUnity API URL: " + url);

                HttpWebRequest request = (HttpWebRequest)WebRequest.Create(url);
                request.Method = "GET";
                request.Timeout = REQUEST_TIMEOUT;
                request.ReadWriteTimeout = REQUEST_TIMEOUT;
                request.UserAgent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
                request.Accept = "application/json, text/javascript, */*; q=0.01";
                request.KeepAlive = false;
                request.AutomaticDecompression = DecompressionMethods.GZip | DecompressionMethods.Deflate;

                Console.WriteLine("+ Sending HTTP request (timeout: " + (REQUEST_TIMEOUT / 1000) + "s)...");

                using (HttpWebResponse response = (HttpWebResponse)request.GetResponse())
                {
                    Console.WriteLine("+ HTTP Status: " + (int)response.StatusCode + " " + response.StatusCode);
                    
                    if (response.StatusCode != HttpStatusCode.OK)
                    {
                        Console.WriteLine("+ XboxUnity API returned non-OK status: " + response.StatusCode);
                        return null;
                    }

                    using (StreamReader reader = new StreamReader(response.GetResponseStream(), Encoding.UTF8))
                    {
                        string jsonResponse = reader.ReadToEnd();
                        Console.WriteLine("+ XboxUnity API response length: " + jsonResponse.Length + " bytes");
                        
                        // Show first 300 chars of response for debugging
                        if (jsonResponse.Length > 0)
                        {
                            string preview = jsonResponse.Substring(0, Math.Min(300, jsonResponse.Length));
                            Console.WriteLine("+ Response preview: " + preview);
                        }
                        
                        string titleName = ParseTitleNameFromJson(jsonResponse);
                        
                        if (!string.IsNullOrEmpty(titleName))
                        {
                            Console.WriteLine("+ ✓ Found game title via API: " + titleName);
                        }
                        else
                        {
                            Console.WriteLine("+ ✗ Could not extract title from API response");
                            Console.WriteLine("+ Full response: " + jsonResponse);
                        }
                        
                        return titleName;
                    }
                }
            }
            catch (WebException ex)
            {
                Console.WriteLine("+ XboxUnity API error (WebException): " + ex.Message);
                Console.WriteLine("  Status: " + ex.Status);
                
                if (ex.Response != null)
                {
                    try
                    {
                        using (StreamReader reader = new StreamReader(ex.Response.GetResponseStream()))
                        {
                            string errorBody = reader.ReadToEnd();
                            Console.WriteLine("  Error body: " + errorBody.Substring(0, Math.Min(200, errorBody.Length)));
                        }
                    }
                    catch { }
                }
                
                return null;
            }
            catch (Exception ex)
            {
                Console.WriteLine("+ XboxUnity API unexpected error: " + ex.Message);
                Console.WriteLine("  Stack: " + ex.StackTrace);
                return null;
            }
        }

        private static string ParseTitleNameFromJson(string json)
        {
            if (string.IsNullOrEmpty(json))
            {
                Console.WriteLine("+ JSON is empty");
                return null;
            }

            try
            {
                // Look for "Name":"Title Name" pattern
                // The response format is: {"Items":[{"TitleID":"...","Name":"Game Name",...}]}
                
                Console.WriteLine("+ Parsing JSON for 'Name' field...");
                
                int nameIndex = json.IndexOf("\"Name\"");
                if (nameIndex == -1)
                {
                    Console.WriteLine("+ ✗ 'Name' field not found in JSON");
                    return null;
                }
                
                Console.WriteLine("+ Found 'Name' at position " + nameIndex);

                // Find the colon after "Name"
                int colonIndex = json.IndexOf(":", nameIndex);
                if (colonIndex == -1)
                {
                    Console.WriteLine("+ ✗ Colon not found after 'Name'");
                    return null;
                }

                // Find the opening quote of the value
                int quoteStart = json.IndexOf("\"", colonIndex + 1);
                if (quoteStart == -1)
                {
                    Console.WriteLine("+ ✗ Opening quote not found");
                    return null;
                }

                // Find the closing quote (accounting for escaped quotes)
                int quoteEnd = quoteStart + 1;
                while (quoteEnd < json.Length)
                {
                    if (json[quoteEnd] == '"' && json[quoteEnd - 1] != '\\')
                    {
                        break;
                    }
                    quoteEnd++;
                }

                if (quoteEnd >= json.Length)
                {
                    Console.WriteLine("+ ✗ Closing quote not found");
                    return null;
                }

                string titleName = json.Substring(quoteStart + 1, quoteEnd - quoteStart - 1);
                
                Console.WriteLine("+ Raw extracted value: '" + titleName + "'");
                
                // Unescape JSON string
                titleName = titleName.Replace("\\\"", "\"")
                                     .Replace("\\\\", "\\")
                                     .Replace("\\/", "/")
                                     .Replace("\\n", " ")
                                     .Replace("\\r", "")
                                     .Trim();
                
                Console.WriteLine("+ After unescape: '" + titleName + "'");
                
                return string.IsNullOrEmpty(titleName) ? null : titleName;
            }
            catch (Exception ex)
            {
                Console.WriteLine("+ JSON parsing exception: " + ex.Message);
                return null;
            }
        }
    }
}
